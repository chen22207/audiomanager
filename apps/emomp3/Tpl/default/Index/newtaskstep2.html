<include file="__THEME__/public_header" />

<div id="page-wrap">
    <div id="main-wrap">
        <div class="boxShadow">
            <div class="foundation">
                <div class="row">
                    <div class="large-12 columns">
                        <h2>发布任务 - 第二步添加音频</h2>
                    </div>
                    <hr/>
                </div>
                <div class="row">
                    <div class="large-6 columns">
                        <p>请选择包含的音频</p>
                    </div>
                    <div class="large-6 columns">
                        <php>
                            $task = D('CpTask')->get($taskid);
                        </php>
                        <p class="right">已添加<span id="audiocount">{:count($task['audioids'])}</span>个音频</p>
                    </div>
                </div>
                <div class="row">
                    <div class="large-12 columns">
                        <table style="width: 100%;" id="audiolist">
                            <thead>
                            <tr>
                                <td>音频编号</td>
                                <td>上传时间</td>
                                <td>选择</td>
                            </tr>
                            </thead>
                            <tbody>
                            <php>
                                $audios = D('CpAudio')->getpage($mid);
                                $task = D('CpTask')->get($taskid);
                            </php>
                            <volist name="audios['data']" id="e">
                                <php>
                                    $checked = "";
                                    $trclass = "";
                                    if(in_array($e['id'], $task['audioids'])) {
                                        $checked = 'checked="1"';
                                        $trclass = 'highlight';
                                    }
                                </php>
                                <tr class="{$trclass}">
                                    <td>{$e['id']}</td>
                                    <td>{$e['ctime']|friendlydate}</td>
                                    <td>
                                        <input type="checkbox" id="selectaudio" audioid="{$e['id']}" {$checked}/>
                                    </td>
                                </tr>
                            </volist>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="row">
                    <div class="page">
                        <p>{$audios['html']}</p>
                    </div>
                </div>
                <div class="row">
                    <div class="large-offset-6 large-6 columns">
                        <div class="expand button" id="finish" taskid="{$taskid}" href="{:U('emomp3/Index/settaskaudio')}">
                            完成
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function(){
        var audiocount = parseInt($('#audiocount').text());
        //翻页时将音频的勾选状态发送到服务器
        $('.page a').click(function(){
            var url = $(this).attr('href');
            saveselection(function(){
                location.href = url;
            });
            return false;
        });
        //点击完成按钮
        $('#finish').click(function(){
            saveselection(function(a,b,c){
                handleajax(a);
            });
        })
        //勾选/取消勾选音频时，增加或减少已添加的音频数量
        $('[id="selectaudio"]').change(function(){
            //增加或减少音频数量
            var checked = $(this).is(':checked');
            if(checked) {
                audiocount++;
            } else {
                audiocount--;
            }
            //显示音频数量
            $('#audiocount').text(audiocount);
        })
        //高亮已选音频
        $('[id="selectaudio"]').change(function(){
            var checked = $(this).is(':checked');
            //类名
            var classname = "";
            if(checked) {
                classname = "highlight";
            }
            //设置背景颜色
            $(this).parent().parent().attr("class", classname);
        })
        //将音频的勾选状态发送到服务器
        function saveselection(callback) {
            //获取音频的勾选状态
            var add = [];
            var remove = [];
            var selections = $('[id="selectaudio"]');
            for(var i=0;i<selections.length;i++) {
                var e = $(selections.get(i));
                var audioid = e.attr('audioid');
                if(e.is(':checked')) {
                    add.push(audioid);
                } else {
                    remove.push(audioid);
                }
            }
            //将状态发送到服务器
            var taskid = $('#finish').attr('taskid');
            var url = $('#finish').attr('href');
            $.post(url, {taskid:taskid,add:add,remove:remove}, function(a,b,c){
                callback(a,b,c);
            });
        }
    })
</script>

<include file="__THEME__/public_footer" />